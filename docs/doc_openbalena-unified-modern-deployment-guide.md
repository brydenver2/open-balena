# openBalena: Unified Modern Deployment & Operations Guide

This document brings together all essential openBalena setup, migration, advanced service, and configuration instructions, focusing on the recent migrations from Kubernetes and HAProxy to Docker Compose and Traefik, as well as the addition of enhanced services.

---

## 1. Getting Started

**openBalena** lets you manage fleets of IoT devices on your own infrastructure (cloud or on-premises).  
You need:
- A **server** (Linux, 2GB+ RAM, Docker installed)
- A **local machine** (Linux, Windows, or macOS, with Docker and balena CLI)
- At least one **supported device** (e.g. Raspberry Pi + balenaOS)

### Domain & DNS
Set up DNS for these subdomains (or a wildcard):
```
api.mydomain.com
ca.mydomain.com
cloudlink.mydomain.com
logs.mydomain.com
ocsp.mydomain.com
registry2.mydomain.com
s3.mydomain.com
tunnel.mydomain.com
```

### Install & Start openBalena
1. Prepare the server (disable cgroups v2 on modern Linux, install Docker, create a `balena` user).
2. Clone the repo and launch:
   ```bash
   git clone https://github.com/balena-io/open-balena.git ~/open-balena
   cd ~/open-balena
   export DNS_TLD=mydomain.com
   make up
   ```
3. Note the `SUPERUSER_EMAIL` and `SUPERUSER_PASSWORD`.  
4. View logs: `docker compose logs -f api`
5. Stop: `make down` & restart: `make restart`

### Test Your Server
- Generate and verify a self-signed cert:
  ```bash
  make self-signed
  make verify
  ```

---

## 2. Reverse Proxy Migration: HAProxy → Traefik

**Why switch?**  
Traefik offers a modern config, better Docker integration, enhanced monitoring, and improved routing.

#### Key Differences & Feature Mapping

| HAProxy (Before) | Traefik (After) | Status |
|------------------|----------------|--------|
| Single config file | Static+dynamic config | ✅ |
| HTTP/HTTPS routing | HTTP routers | ✅ |
| SSL termination | TLS config | ✅ |
| Authentication | BasicAuth middleware | ✅ |
| Health checks | Health checks | ✅ |
| Stats | Dashboard | ✅ |
| TCP (VPN) | TCP routers | ✅ |

**Example Docker Compose update:**
```yaml
# Old
haproxy:
  build: src/haproxy
  ports: ['80:80', '443:443', '1936:1936']

# New
traefik:
  build: src/traefik
  ports: ['80:80', '443:443', '1936:1936']
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
```

**Routing Patterns:**
- `api.*` → api-service
- `registry2.*` → registry-service
- `s3.*` → s3-service
- `minio.*` → minio-service
- `ca.*` → ca-service (auth)
- `ocsp.*` → ocsp-service
- `/health` → API
- `/api/v1/cfssl/crl` → CA (no auth)
- `tunnel.*` (SNI) → VPN

**SSL/TLS:**  
Traefik uses TLS 1.2+, modern ciphers, and supports the old `HAPROXY_CRT`/`KEY` env vars as `TRAEFIK_CRT`/`KEY`.

**Monitoring:**  
Traefik dashboard at port 1936.

**Migration Steps:**
1. Backup: HAProxy config preserved in `src/haproxy/`
2. Update Docker Compose as above
3. Validate: `make config`, `docker compose config`
4. Verify: `make verify`

**Troubleshooting:**  
Validate config, check logs (`docker compose logs traefik`), check cert/DNS/ports.

**Rollback:**  
Restore old HAProxy service in Compose, update Makefile, remove Traefik config.

---

## 3. Enhanced Services: Modern Additions

**These services migrated from Kubernetes Helm and are now included by default.**

| Service    | Subdomain              | Purpose                      |
|------------|------------------------|------------------------------|
| UI         | `admin.*`              | Web dashboard                |
| Builder    | `builder.*`            | Multi-arch container builds  |
| Delta      | `delta.*`              | Efficient device updates     |
| PostgREST  | `postgrest.*`          | REST API for PostgreSQL      |
| Remote     | `remote.*` + TCP 10000-10009 | Remote device SSH/terminal |
| Helper     | Routed via API         | Download/supervisor utilities|

- All services sit behind Traefik with HTTPS enforced.
- Health/status: `docker compose ps`, Traefik dashboard
- Logs: `docker compose logs [service]`
- Resource usage: `docker stats`
- Custom images/env: Use `docker-compose.override.yml`
- Security: JWT, DB roles, service tokens

---

## 4. Environment Variables Cheat Sheet

- **Core:**  
  - `DNS_TLD`, `SUPERUSER_EMAIL`, `SUPERUSER_PASSWORD`
- **Enhanced Services:**  
  - `BANNER_IMAGE` (UI logo), `OPENBALENA_API_VERSION`, `REMOTE_SENTRY_DSN`, `TUNNEL_TOKEN`
  - `COOKIE_SESSION_SECRET`, `JSON_WEB_TOKEN_SECRET`, ... (autogenerated)
- **Service URLs:**  
  - `REACT_APP_OPEN_BALENA_UI_URL`, etc. (auto)
- **Database:**  
  - `PGRST_DB_URI`, `PGRST_DB_SCHEMA`, `PGRST_DB_ANON_ROLE`
- **Hostnames:**  
  - `API_HOST`, `DELTA_HOST`, `BUILDER_HOST`, `S3_HOST`
- **Volumes:**  
  - `builder-storage`, `delta-storage`, `helper-storage`

---

## 5. External Service Configuration

Use external managed PostgreSQL or S3/MinIO for production:

### External PostgreSQL
Set:
- `EXTERNAL_POSTGRES=true`
- `EXTERNAL_POSTGRES_HOST`, `EXTERNAL_POSTGRES_PORT` (5432), `EXTERNAL_POSTGRES_USER`, `EXTERNAL_POSTGRES_PASSWORD`, `EXTERNAL_POSTGRES_DATABASE`

**Example:**
```bash
DNS_TLD=mybalena.local \
EXTERNAL_POSTGRES=true \
EXTERNAL_POSTGRES_HOST=postgres.example.com \
EXTERNAL_POSTGRES_USER=balena \
EXTERNAL_POSTGRES_PASSWORD=securepassword \
EXTERNAL_POSTGRES_DATABASE=balena \
make up
```

### External S3/MinIO
Set:
- `EXTERNAL_S3=true`
- `EXTERNAL_S3_ENDPOINT`, `EXTERNAL_S3_ACCESS_KEY`, `EXTERNAL_S3_SECRET_KEY`, `EXTERNAL_S3_REGION` (us-east-1)

**Example:**
```bash
DNS_TLD=mybalena.local \
EXTERNAL_S3=true \
EXTERNAL_S3_ENDPOINT=minio.example.com \
EXTERNAL_S3_ACCESS_KEY=minioadmin \
EXTERNAL_S3_SECRET_KEY=minioadmin \
make up
```

### Using Both
Combine all relevant variables in one `make up` command.

**Notes:**
- Internal DB/S3 containers are disabled if external services are used.
- Ensure required buckets, DB schema, and network access are set up externally.

---

## 6. Kubernetes to Docker Migration

All `open-balena-helm` (K8s) functionality is now in Docker Compose:

| K8s Resource | Docker Compose Service | Access         |
|--------------|-----------------------|---------------|
| UI           | ui                    | `admin.*`     |
| Builder      | builder               | `builder.*`   |
| Delta        | delta                 | `delta.*`     |
| PostgREST    | postgrest             | `postgrest.*` |
| Remote       | remote                | `remote.*`    |
| Helper       | helper (via API)      | -             |

- K8s PVCs → Docker volumes (e.g. `builder-storage`)
- K8s Ingress → Traefik routing
- K8s secrets → Docker env/volumes
- Health checks/logs: `docker compose logs`, Traefik dashboard
- No K8s cluster needed: simpler, single-node, easier dev/testing

**Migration Steps:**
1. Backup K8s data
2. `helm uninstall openbalena`
3. Set up Docker Compose
4. Copy data to volumes if needed
5. Update DNS to Docker host
6. `make up`

---

## 7. Troubleshooting & Monitoring

- **General health:** `docker compose ps`
- **Logs:** `docker compose logs [service]`
- **Traefik dashboard:** `https://yourdomain.com:1936`
- **Resource stats:** `docker stats`
- **Service status:** `docker compose ps`
- **Debug routing:** `docker compose logs traefik`

**Common Issues:**
- Service not accessible: check Traefik, Compose, ports, DNS
- Build failures: Docker socket, disk space, logs
- External DB/S3: schema, buckets, network

---

## 8. Security & Customization

- All external access via HTTPS (Traefik)
- Internal services on Docker network
- JWT, DB roles, device authentication
- Use `docker-compose.override.yml` for custom images, resource limits, and overrides

---

## 9. Resources & References

- Main repo: https://github.com/balena-io/open-balena
- [balena CLI installation](https://github.com/balena-io/balena-cli/blob/master/INSTALL.md)
- For further help: Check GitHub issues, or [balena.io/support](https://www.balena.io/support)

---

**You are now ready to deploy, manage, and extend openBalena using Docker Compose and Traefik, with all enhanced and externalized services!**